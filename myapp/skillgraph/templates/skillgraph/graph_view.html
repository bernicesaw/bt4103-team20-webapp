{% extends 'base.html' %} 
{% load humanize %}

{% block title %}{{ page_title }}{% endblock %} 

{% block extra_head %}
<script src="https://d3js.org/d3.v7.min.js"></script>

<style>
    /* ... (your existing page layout styles) ... */
    main.container-fluid {
        padding-top: 1rem;
        padding-bottom: 1rem;
    }
    #graph-container-wrapper {
        /* Made container longer by reducing the subtracted value */
        min-height: calc(100vh - 150px); 
        height: 100%;
        width: 100%;
        background-color: #ffffff;
    }
    .jobs-panel-scroll {
        max-height: calc(100vh - 120px); 
        overflow-y: auto;
        padding-right: 0.5rem;
    }
    .job-header {
        cursor: pointer;
        padding: 0.75rem 1rem;
        border-radius: 0.25rem;
        margin-bottom: 0.5rem;
        transition: background-color 0.2s ease;
        border: 1px solid #e9ecef;
        background-color: #f8f9fa;
    }
    .job-header:hover {
        background-color: #e2e6ea;
    }
    .job-rank {
        display: inline-block;
        min-width: 1.5rem;
        text-align: center;
        font-weight: bold;
        color: var(--app-purple);
    }

    /* 2. D3 styles for the Egonet */
    .d3-link {
        stroke-opacity: 0.8;
        stroke-width: 2.5px;
    }

    /* Style for the central "Ego" node */
    .d3-node-ego circle {
        stroke: #fff;
        stroke-width: 2px;
        fill: var(--app-purple, #6f42c1);
    }

    /* Style for all the "transition" job nodes */
    .d3-node-transition circle {
        stroke: #fff;
        stroke-width: 1.5px;
        fill: #17a2b8; /* Bootstrap 'info' blue */
    }

    .d3-node-label {
        font-size: 11px;
        font-weight: 600;
        fill: #343a40;
        pointer-events: none;
        text-anchor: middle;
        /* transform: translateY(-18px); --- REMOVED: We now set 'y' directly */
    }
    
    .d3-node-label.ego-label {
        font-size: 14px;
        fill: var(--app-purple, #6f42c1);
        /* transform: translateY(-22px); --- REMOVED: We now set 'y' directly */
    }

    /* 3. NEW Legend Styles */
    #graph-legend {
        position: absolute;
        bottom: 1rem;
        right: 1rem;
        background-color: rgba(255, 255, 255, 0.9);
        padding: 0.75rem;
        border-radius: 0.375rem; /* 6px */
        border: 1px solid #e9ecef;
        box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
        font-size: 12px;
        display: none; /* Will be shown by JS */
    }
    #legend-svg {
        display: block;
    }
    .legend-label {
        font-size: 11px;
        font-weight: 600;
        fill: #555;
    }
</style>
{% endblock %}

{% block content %}
<h1 class="mb-4 text-app-purple fw-light">{{ page_title }}</h1>

<div class="row">
    
    <div class="col-lg-9 mb-4">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-header bg-light border-bottom d-flex justify-content-between align-items-center">
                <h5 class="mb-0 text-muted">Job Transition Network</h5>
                </div>
            <div class="card-body p-1">
                <div id="graph-container-wrapper" style="position: relative;">
                    <div id="graph-container" class="h-100 w-100 d-flex justify-content-center align-items-center">
                        <p class="text-muted text-center m-0 p-5 lead">
                            {{ intro_message|default:"Your job transition network will appear here." }}
                        </p>
                    </div>
                    
                    <div id="graph-legend">
                        <h6 class="mb-1 small fw-bold text-muted">Transition Difficulty</h6>
                        <svg id="legend-svg" width="150" height="30"></svg>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 mb-4">
        <div class="card shadow-sm border-0 sticky-top" style="top: 1.5rem;">
            <div class="card-header border-bottom py-3">
                <h6 class="mb-0 fw-bold" style="color: var(--app-purple);">All Jobs</h6>
            </div>
            
            <div class="card-body jobs-panel-scroll p-3">
                
                <div class="accordion accordion-flush" id="recommendedJobsAccordion">
                    
                    {% for job in recommended_jobs %}
                    <div class="accordion-item border-0 bg-transparent mb-2">
                        <h2 class="accordion-header" id="heading{{ forloop.counter }}">
                            <div class="job-header collapsed" 
                                data-bs-toggle="collapse" 
                                data-bs-target="#collapse{{ forloop.counter }}" 
                                aria-expanded="false" 
                                aria-controls="collapse{{ forloop.counter }}">
                                <span class="job-rank">{{ forloop.counter }}.</span>
                                <strong class="ms-2">{{ job.name }}</strong>
                            </div>
                        </h2>
                        
                        <div id="collapse{{ forloop.counter }}" class="accordion-collapse collapse" aria-labelledby="heading{{ forloop.counter }}" data-bs-parent="#recommendedJobsAccordion">
                            <div class="accordion-body p-3 pt-1 border-start border-end border-bottom" style="border-color: #e9ecef !important; background-color: #ffffff;">
    
                                <h6 class="small text-dark mb-2 fw-bold">Details</h6>
                                <p class="small text-muted mb-1">
                                    <strong>Avg. Experience:</strong> 
                                    {{ job.work_exp }} years
                                </p>
                                <p class="small text-muted mb-3">
                                    <strong>Avg. Compensation:</strong> 
                                    ${{ job.yearly_comp|intcomma }}
                                </p>
                            
                                <h6 class="small text-dark mb-2 fw-bold">Top Skills</h6>
                                <div class="d-flex flex-wrap">
                                    {% for skill in job.skills %}
                                        <span class="badge rounded-pill text-bg-light border me-1 mb-1 fw-normal text-wrap">{{ skill }}</span>
                                    {% empty %}
                                        <span classs="small text-muted">No specific skills listed.</span>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                        <p class="text-muted text-center small p-3">No recommended jobs found.</p>
                    {% endfor %}

                </div>
            </div>
        </div>
    </div>
</div>

{{ recommended_jobs|json_script:"jobs-data" }}
{{ graph_data|json_script:"graph-data" }}

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // A. Get the graph data element
        const graphDataElement = document.getElementById('graph-data');
        
        // Check if the element exists and has content.
        if (!graphDataElement || !graphDataElement.textContent) {
            console.error('D3 Error: The "graph-data" element was not found or is empty.');
            console.log('This usually means the "graph_data" variable from the view was empty or null.');
            return; // Stop the script
        }
        
        // Now it's safe to parse the content
        const graphData = JSON.parse(graphDataElement.textContent);

        // B. Handle the case where no data is available
        if (!graphData || !graphData.transitions || graphData.transitions.length === 0) {
            console.log('No graph data found. D3 egonet will not be rendered.');
            return; 
        }

        // C. Process the data into D3-readable nodes and links
        const nodes = [];
        const links = [];
        
        // 1. Create the central "Ego" node
        const egoNodeId = graphData.ego_node || "My Role";
        const egoNode = { id: egoNodeId, type: 'ego' };
        nodes.push(egoNode);

        // 2. Create transition nodes and links
        graphData.transitions.forEach(job => {
            nodes.push({ id: job.transition_job, type: 'transition' });
            links.push({ 
                source: egoNode.id, 
                target: job.transition_job, 
                weight: job.transition_weight 
            });
        });

        // D. Create the color scale based on weight
        const weights = links.map(d => d.weight);
        const minWeight = Math.min(...weights);
        const maxWeight = Math.max(...weights);
        
        // --- 1. CHANGED: Reversed the color range ---
        // Now minWeight (easier) = Light Gray, maxWeight (harder) = Dark Purple
        const colorScale = d3.scaleLinear()
            .domain([minWeight, maxWeight])
            .range(["#e0e0e0", "#6f42c1"]); // Light Gray to Dark Purple

        // E. Set up the D3 container and SVG
        const container = document.getElementById('graph-container');
        container.innerHTML = ''; // Clear the placeholder text

        // --- NEW ---
        // Now that we're drawing the graph, also draw the legend.
        (function drawLegend() {
            // Show the legend container
            document.getElementById('graph-legend').style.display = 'block';

            const legendSvg = d3.select("#legend-svg");
            const width = +legendSvg.attr("width");
            const height = +legendSvg.attr("height");
            
            // Create a gradient definition
            const defs = legendSvg.append("defs");
            const linearGradient = defs.append("linearGradient")
                .attr("id", "legend-gradient")
                .attr("x1", "0%")
                .attr("y1", "0%")
                .attr("x2", "100%")
                .attr("y2", "0%");

            linearGradient.append("stop")
                .attr("offset", "0%")
                .attr("stop-color", colorScale(minWeight)); // Light color (min weight)

            linearGradient.append("stop")
                .attr("offset", "100%")
                .attr("stop-color", colorScale(maxWeight)); // Dark color (max weight)

            // Draw the gradient bar
            legendSvg.append("rect")
                .attr("x", 0)
                .attr("y", 10) // Give space for top label
                .attr("width", width)
                .attr("height", 15)
                .style("fill", "url(#legend-gradient)");

            // --- 2. CHANGED: Update Min label text ---
            legendSvg.append("text")
                .attr("class", "legend-label")
                .attr("x", 0)
                .attr("y", 8) // Above the bar
                .text('Easier');
            
            // --- 3. CHANGED: Update Max label text ---
            legendSvg.append("text")
                .attr("class", "legend-label")
                .attr("x", width)
                .attr("y", 8) // Above the bar
                .attr("text-anchor", "end")
                .text('Harder');
        })();
        // --- END NEW ---


        const width = container.clientWidth;
        const height = container.clientHeight;

        const svg = d3.select(container).append("svg")
            .attr("viewBox", [0, 0, width, height])
            .attr("width", width)
            .attr("height", height)
            .attr("style", "max-width: 100%; height: auto;");

        // F. Create the simulation
        const simulation = d3.forceSimulation(nodes)
            .force("link", d3.forceLink(links).id(d => d.id).distance(200)) 
            .force("charge", d3.forceManyBody().strength(-600)) 
            .force("center", d3.forceCenter(width / 2, height / 2))
            // Add a collision force to prevent nodes/labels from overlapping
            .force("collide", d3.forceCollide().radius(d => d.type === 'ego' ? 70 : 60)) // 70px for ego, 60px for others
            .on("tick", ticked);

        // G. Draw the links (lines)
        const link = svg.append("g")
            .attr("class", "d3-links")
            .selectAll("line")
            .data(links)
            .join("line")
            .attr("class", "d3-link")
            .style("stroke", d => colorScale(d.weight));

        // H. Draw the nodes (circles AND labels)
        // We create a <g> element for each node
        const node = svg.append("g")
            .attr("class", "d3-nodes")
            .selectAll("g")
            .data(nodes)
            .join("g") // <-- This group holds both circle and text
            .attr("class", d => d.type === 'ego' ? 'd3-node-ego' : 'd3-node-transition')
            .call(drag(simulation)); // Enable dragging

        // Add the circle to the node group
        node.append("circle")
            .attr("r", d => d.type === 'ego' ? 20 : 12); // Ego node is bigger

        // Add the tooltip to the node group
        node.append("title")
            .text(d => d.id);
            
        // Add the text label to the node group
        node.append("text")
            .text(d => d.id)
            .attr("class", d => d.type === 'ego' ? 'd3-node-label ego-label' : 'd3-node-label')
            // Position label above the circle (radius + padding)
            .attr("y", d => d.type === 'ego' ? -25 : -18);

        // J. Define the 'ticked' function (updates positions)
        function ticked() {
            link
                .attr("x1", d => d.source.x)
                .attr("y1", d => d.source.y)
                .attr("x2", d => d.target.x)
                .attr("y2",d => d.target.y);

            // We only need to move the group, the label inside it moves automatically
            node
                .attr("transform", d => `translate(${d.x},${d.y})`);
            
        }

        // K. Define drag behavior (reusable)
        function drag(simulation) {
            function dragstarted(event, d) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                d.fx = d.x;
                d.fy = d.y;
            }
            function dragged(event, d) {
                d.fx = event.x;
                d.fy = event.y;
            }
            function dragended(event, d) {
                if (!event.active) simulation.alphaTarget(0);
                d.fx = null;
                d.fy = null;
            }
            return d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended);
        }
    });
</script>
{% endblock %}